import{_ as o}from"./chunks/ArticleMetadata.41rSz6Gb.js";import{_ as d,D as t,o as e,c as g,k as l,a as n,I as h,w as c,R as y,b as A,e as D}from"./chunks/framework.lWSK3XUC.js";import"./chunks/md5.US-HucPO.js";const u="/vuepress-blog/assets/gokit.O_UK4nEn.png",I=JSON.parse('{"title":"GoKit Intro","description":"","frontmatter":{"title":"GoKit Intro","author":"ChocolateAceCream","date":"2024/03/05 19:00","isTop":true,"categories":["DevOps"],"tags":["GoKit","Go"]},"headers":[],"relativePath":"categories/DevOps/2024/03/05/GoKit_Intro.md","filePath":"categories/DevOps/2024/03/05/GoKit_Intro.md","lastUpdated":1714766746000}'),C={name:"categories/DevOps/2024/03/05/GoKit_Intro.md"},B={id:"gokit-intro",tabindex:"-1"},m=l("a",{class:"header-anchor",href:"#gokit-intro","aria-label":'Permalink to "GoKit Intro <Badge text="GoKit" type="warning" />"'},"​",-1),F=y('<h3 id="layout" tabindex="-1">Layout <a class="header-anchor" href="#layout" aria-label="Permalink to &quot;Layout&quot;">​</a></h3><p><img src="'+u+`" alt="layout"> explain: when req comes in, it first go through transport layer, which can take rpc, http or gRPC calls, decode request and pass the request through multiple middlewares, such as metrics, load balance/rate limiter, logger tools, etc... and finally routed to a endpoint which call the service which contains business logics.</p><p>a typical main.go in go kit is large, and may like this:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> log.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> service todo.Service    </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// interface</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> todo.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewService</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// concrete struct</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> todo.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewLoggingMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(logger)(service)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">endpoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> todo.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewEndpoints</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(service)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">transport </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> todo.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewHTTPTransport</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(endpoints)</span></span></code></pre></div><p>where endpoints act as an action/handler to route the req to service which contains business logics.</p><p>p.s. if you implement two transports(http and gRPC), you might have two methods of sending requests to the same endpoint.</p><h3 id="errors-handling" tabindex="-1">Errors handling <a class="header-anchor" href="#errors-handling" aria-label="Permalink to &quot;Errors handling&quot;">​</a></h3><p>option1: have an error field in your response struct and return business domain errors there option2: return business domain errors in the endpoint error return value.</p><p>Both methods can be made to work. But errors returned directly by endpoints are recognized by middlewares that check for failures, like circuit breakers. It’s unlikely that a business-domain error from your service should cause a circuit breaker to trip in a client. So, it’s likely that you want to encode errors in your response struct.</p><h3 id="supported-3rd-party-tools-platforms" tabindex="-1">Supported 3rd party tools/platforms <a class="header-anchor" href="#supported-3rd-party-tools-platforms" aria-label="Permalink to &quot;Supported 3rd party tools/platforms&quot;">​</a></h3><ul><li>transport protocol: http, gRPC, net/rpc, Thrift</li><li>service discovery: consul, etcd, zookeeper</li><li>observability: Prometheus(recommend), InfluxDB</li></ul><h3 id="panics-handling" tabindex="-1">Panics handling <a class="header-anchor" href="#panics-handling" aria-label="Permalink to &quot;Panics handling&quot;">​</a></h3><p>Once panic happened, you should allow them to crash your program or handler goroutine, and return a broken response to the calling client. So observability will notice the panic and alert you to fix them ASAP</p><p>But if you want to handle exceptions, best practice is to wrap the concrete transport with a transport-specific middleware that performs a recover. e.g</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> h http.Handler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> httptransport.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">NewServer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> newRecoveringMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(h, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// use h normally</span></span></code></pre></div><h3 id="db" tabindex="-1">db <a class="header-anchor" href="#db" aria-label="Permalink to &quot;db&quot;">​</a></h3><p>db connection is usually required only in your business logic, so you can create a simple persistence layer of db interface like this</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Store</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Insert</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(Profile) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Select</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) (Profile, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">	Delete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> databaseStore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{ db </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">sql.DB }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">databaseStore) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Insert</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(p Profile) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            { </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">/* ... */</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">databaseStore) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Select</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) (Profile, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) { </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">/* ... */</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">databaseStore) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Delete</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">            { </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">/* ... */</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span></code></pre></div>`,18);function E(s,b,f,v,_,w){const r=t("Badge"),p=o,k=t("ClientOnly");return e(),g("div",null,[l("h1",B,[n("GoKit Intro "),h(r,{text:"GoKit",type:"warning"}),n(),m]),h(k,null,{default:c(()=>{var i,a;return[(((i=s.$frontmatter)==null?void 0:i.aside)??!0)&&(((a=s.$frontmatter)==null?void 0:a.showArticleMetadata)??!0)?(e(),A(p,{key:0,article:s.$frontmatter},null,8,["article"])):D("",!0)]}),_:1}),F])}const x=d(C,[["render",E]]);export{I as __pageData,x as default};
