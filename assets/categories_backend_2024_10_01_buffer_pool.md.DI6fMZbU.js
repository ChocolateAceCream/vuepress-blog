import{_ as k}from"./chunks/ArticleMetadata.CniVkZ4f.js";import{_ as d,m as e,a as c,e as o,x as t,u as n,B as u,ah as f,o as l,p as g,q as y}from"./chunks/framework.BuAcqOzq.js";import"./chunks/theme.KGDKc3lz.js";const x=JSON.parse('{"title":"Buffer Pool","description":"","frontmatter":{"title":"Buffer Pool","author":"ChocolateAceCream","date":"2024/10/01 19:00","isTop":false,"categories":["backend"],"tags":["Go"]},"headers":[],"relativePath":"categories/backend/2024/10/01/buffer_pool.md","filePath":"categories/backend/2024/10/01/buffer_pool.md","lastUpdated":1743100343000}'),b={name:"categories/backend/2024/10/01/buffer_pool.md"},A={id:"buffer-pool",tabindex:"-1"},D=o("a",{class:"header-anchor",href:"#buffer-pool","aria-label":'Permalink to "Buffer Pool <Badge text="Go" type="warning" />"'},"​",-1),C=f(`<h2 id="why-buffer-pool" tabindex="-1">Why buffer pool <a class="header-anchor" href="#why-buffer-pool" aria-label="Permalink to &quot;Why buffer pool&quot;">​</a></h2><p>When buffers are frequently used and discarded (like http response writer), using buffer pool can avoid excessive memory allocations.</p><h2 id="what-is-buffer-pool" tabindex="-1">What is buffer pool <a class="header-anchor" href="#what-is-buffer-pool" aria-label="Permalink to &quot;What is buffer pool&quot;">​</a></h2><p>A pool to store buffers, usually have a get() and put(), where get() will return a buffer from pool if existing unused buffers, or create new buffer if no existing buffers in pool. and put() will reset buffer and then return the buffer to the pool for recycling.</p><p>P.S buffers in buffer pool can be GC, once no goroutine request that buffer for a certain time, then GC will recycle the buffer from pool. So buffer pool in go like sync.Pool is designed for short-lived, frequently reused objects.</p><h2 id="how-to-use" tabindex="-1">How to use <a class="header-anchor" href="#how-to-use" aria-label="Permalink to &quot;How to use&quot;">​</a></h2><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">bytes</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">fmt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sync</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> bufferPool </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> sync</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	New: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">{} {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">		return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	buf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> bufferPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">().(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> bufferPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Put</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(buf)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	buf.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Reset</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	buf.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">WriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;Hello world&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	buf.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">WriteString</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">!!!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(buf.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h3 id="get-put-and-reset" tabindex="-1">get(), put() and reset() <a class="header-anchor" href="#get-put-and-reset" aria-label="Permalink to &quot;get(), put() and reset()&quot;">​</a></h3><p>get() will return objects from buffer pool, after use, use put() to put object back to pool. you can call reset() before put() to make sure value is cleaned, or right after get()</p><h2 id="what-s-behind-buffer-pool-sync-pool" tabindex="-1">What&#39;s behind buffer pool (sync.Pool) <a class="header-anchor" href="#what-s-behind-buffer-pool-sync-pool" aria-label="Permalink to &quot;What&#39;s behind buffer pool (sync.Pool)&quot;">​</a></h2><p>In order to understand how buffer pool works, first we need to understand logical processor (P) of G-M-P scheduling model (Goroutine-Machine-Processor)</p><h4 id="g-m-p-model-overview" tabindex="-1"><strong>G-M-P Model Overview</strong> <a class="header-anchor" href="#g-m-p-model-overview" aria-label="Permalink to &quot;**G-M-P Model Overview**&quot;">​</a></h4><table><thead><tr><th>Component</th><th>Role</th></tr></thead><tbody><tr><td><strong>G (Goroutine)</strong></td><td>Lightweight thread managed by Go.</td></tr><tr><td><strong>M (Machine)</strong></td><td>OS thread (real CPU thread).</td></tr><tr><td><strong>P (Processor)</strong></td><td>Schedules goroutines onto <code>M</code>s.</td></tr></tbody></table><h4 id="how-ps-work-with-sync-pool" tabindex="-1">How Ps work with sync.Pool <a class="header-anchor" href="#how-ps-work-with-sync-pool" aria-label="Permalink to &quot;How Ps work with sync.Pool&quot;">​</a></h4><p>Each P has its own local cache to put sync.Pool objects. When you call Put() or Get(), the operation first tries the current P’s local cache (lock-free, fast path). If the local cache is full/empty, it interacts with the global pool (requires a mutex, slow path).</p><p>So, in order to go with fast path, one way is to increase GOMAXPROCS (usually set to the # of CPU cores), which is equal to number of Ps. More Ps means more local caches and less chance of going to slow path</p><h4 id="global-pool" tabindex="-1">global pool <a class="header-anchor" href="#global-pool" aria-label="Permalink to &quot;global pool&quot;">​</a></h4><p>rarely used, act as a backup plan if P&#39;s local cache overflows.</p><ul><li>When a P’s local cache overflows (e.g., too many Put() calls), excess objects spill into the global pool.</li><li>When a P’s local cache is empty (e.g., too many Get() calls), it can steal objects from the global pool.</li></ul>`,19);function F(s,m,B,w,P,_){const h=e("Badge"),r=k,p=e("ClientOnly");return l(),c("div",null,[o("h1",A,[t("Buffer Pool "),n(h,{text:"Go",type:"warning"}),t(),D]),n(p,null,{default:u(()=>{var a,i;return[(((a=s.$frontmatter)==null?void 0:a.aside)??!0)&&(((i=s.$frontmatter)==null?void 0:i.showArticleMetadata)??!0)?(l(),g(r,{key:0,article:s.$frontmatter},null,8,["article"])):y("",!0)]}),_:1}),C])}const G=d(b,[["render",F]]);export{x as __pageData,G as default};
